{
    type : "Composite",
    "name" : "sites",
    "required" : [ 
        "samplingpoint", 
        "ncsx",
        "ncsy",
        "longitude_etrs89",
        "latitude_etrs89",
        "description_english",
        "eubwid",
        "sediment_types",
        "bathing_water_type",
        "os_uri",
        "gss",
        "country",
        "rbdid",
        "rbdname",
        "impact_from_heavy_rainfall",
        "bb_xmin",
        "bb_xmax",
        "bb_ymin",
        "bb_ymax",
        "des_year",
        "ea_region"
    ],
    "bind" : [
        {
            "$source_base" : "http://environment.data.gov.uk/sources/bwq",
            "$body_slug"   : "eaew",
            "$sourceFileName" : "bw_sites.csv",
            "$outputFileName" : "reference.ttl",
            "$runDate"     : "2014-09-05T18:46:32^^xsd:dateTime", 
            "$def_bw"  : "http://environment.data.gov.uk/def/bathing-water",
            "$def_sp"  : "http://location.data.gov.uk/def/em/SamplingPoint",
            "$id_bw"   : "http://environment.data.gov.uk/id/bathing-water",
            "$so_sp"   : "http://location.data.gov.uk/so/em/SamplingPoint/bwsp.eaew",
            "$so_env"  : "http://location.data.gov.uk/so/common/Envelope/bwpf.eaew",
            "$so_zoi"  : "http://location.data.gov.uk/doc/ef/ZoneOfInfluence/bwzoi.eaew",
            "$bwspid"  : "{samplingpoint.format('%05d')}",
            "$eubwid"  : "{eubwid.trim().toLowerCase().replaceAll('\\s+','-')}", # replace running whitespace with a single '-'
            "$altBwId" : "{description_english.replaceAll('[-#$&?]+',' ').replaceAll('[\\'`(),]','').trim().replaceAll('\\s+','-').toLowerCase()}",
            "$s_bwt"   : "{bathing_water_type.toLowerCase()}",
            "$eaRegion" : "{ea_region.map('region')}",
            "$sediment" : "{sediment_types.toLowerCase().replaceAll('\\\\sand\\\\s',',')}",
            "$srsDim"  : "2",
            "$srs"     : "http://www.opengis.net/def/crs/EPSG/0/27700",
         ## Add 0.0 to coerce decimal literals
            "$northing" : "{ncsy.value + 0.0}^^xsd:decimal",
            "$easting"  : "{ncsx.value + 0.0}^^xsd:decimal",        
         #######################################################################################################################
         # Rectify and round min and max x and y bounding box values up (max's) and down (min's)
         #######################################################################################################################  
            "$bb_xmax" : "{round((bb_xmax.value >= bb_xmin.value ? bb_xmax : bb_xmin).value + 0.5).value + 0.0}",
            "$bb_xmin" : "{round((bb_xmax.value >= bb_xmin.value ? bb_xmin : bb_xmax).value - 0.5).value + 0.0}",
            "$bb_ymax" : "{round((bb_ymax.value >= bb_ymin.value ? bb_ymax : bb_ymin).value + 0.5).value + 0.0}",
            "$bb_ymin" : "{round((bb_ymax.value >= bb_ymin.value ? bb_ymin : bb_ymax).value - 0.5).value + 0.0}"
        },
        {
            "$envelopeGML" : "\\<gml:Envelope xmlns:gml=\"http://www.opengis.net/gml/3.2\" srsName=\"http://www.opengis.net/def/crs/EPSG/0/27700\"> <gml:lowerCorner>{$bb_xmin} {$bb_ymin}</gml:lowerCorner><gml:upperCorner>{$bb_xmax} {$bb_ymax}</gml:upperCorner></gml:Envelope>"
        }
    ],
    "oneOffs" : [
        { "name"              : "bathing-water-dataset",
          "@id"               : "<{$id_bw}/>",
          "<rdf:type>"        : [ "<dgu:URIset>", "<void:Dataset>" ],
          "<void:vocabulary>" : [ "<admingeo:>", "<onsadmingeo:>", "<def-sp:>", "<def-bw:>", "<dgu:>", "<skos:>", "<geo:>", "<def-geom:>", "<geometry:>" ] ,
          "<rdfs:label>"      : "Bathing waters monitored by the Environment Agency for England and Wales.@en",
          "<dct:description>" : "URI Set of Bathing Waters in England and Wales monitored by the Environment Agency for compliance with the EU Bathing Water Directive@en",
          "<dct:license>"     : "<http://reference.data.gov.uk/id/open-government-licence>",
          "<dct:source>"      : "<{$source_base}/{$body_slug}/input/{$sourceFileName}>",
          "<dct:modified>"    : "{$runDate}",
          "<void:uriRegexPattern>" : "<{$id_bw}/.*>",
          "<void:dataDump>"   : "<{$source_base}/{$body_slug}/output/{$outputFileName}>",
          "<dgu:itemType>"    : "<def-bw:BathingWater>",
          "<dgu:status>"      : "<dgu:draft>"         
        }
    ],
    "sources" : [
        {
            "name"       : "region",
            "sourceType" : "CSV",
            "source"     : "transform/ea-region.csv",
            "key"        : "code",
            "value"      : "region"
        },
        {
            "name"       : "sediment",
            "sourceType" : "CSV",
            "source"     : "transform/sediment.csv",
            "key"        : "code",
            "value"      : "sediment_type",
            "makeURI"    : "true"
        },
        {
            "name"       : "bw_type",
            "sourceType" : "CSV",
            "source"     : "transform/bw_type.csv",
            "key"        : "code",
            "value"      : "bw_type",
            "makeURI"    : "true"
        }
    ],
    "templates" : [ "bathing-water", "alt-bathing-water", "envelope", "envelope-lower", "envelope-upper", "zone-of-influence",
                    "zoi-extent", "sampling-point",  "os-district", "ons-district" ],
    "referenced" : [
    #############################################################################################################################
    # Bathing-water reference data
    # 
    # @@TODO@@ : resolve county references and import OS linked data fragments
    #
    #############################################################################################################################
        {   "name"                                     : "bathing-water",
            "@id"                                      : "<{$id_bw}/{$eubwid}>",
            "<dgu:uriSet>"                             : "<{$id_bw}/>",
            "<rdf:type>"                               : [ "<def-bw:BathingWater>", "<{bathing_water_type.map('bw_type')}>" ],
            "<rdfs:label>"                             : [ "{description_english.lang('en')}", 
                                                           "{empty(description_welsh) ? null : description_welsh.lang('cy') }" ],
            "<skos:prefLabel>"                         : [ "{description_english.lang('en')}", 
                                                           "{empty(description_welsh) ? null : description_welsh.lang('cy') }" ],
            "<def-bw:eubwidNotation>"                  : "{$eubwid.datatype('def-bw:eubwid')}",
            "<skos:notation>"                          : [ "{$eubwid.datatype('def-bw:eubwid')}", "{$eubwid}" ],
            "<onsadmingeo:country>"                    : "<{country == 'E' ? 'http://data.ordnancesurvey.co.uk/id/country/england' :
                                                            country == 'W' ? 'http://data.ordnancesurvey.co.uk/id/country/wales' : null }>",
            "<def-sp:samplingPoint>"                   : "<{$so_sp}/{$bwspid}>",
            "<owl:sameAs>"                             : "<{$id_bw}/{$altBwId}>",
            "<def-bw:yearDesignated>"                  : "{empty(des_year)    ? null : des_year.asDate('xsd:gYear').referenceTime()}",
            "<def-bw:yearDedesignated>"                : "{empty(de_des_year) ? null : de_des_year.asDate('xsd:gYear').referenceTime()}",
            "<def-bw:regionalOrganization>"            : "<{$eaRegion}>",
            "<def-bw:sedimentTypePresent>"             : "<{$def_bw}/{$sediment.split(',')}_sediment>",
            "<def-bw:waterQualityImpactedByHeavyRain>" : "{impact_from_heavy_rainfall.toLowerCase()=='yes' ? true :
                                                           impact_from_heavy_rainfall.toLowerCase()=='no'  ? false : null }",
            "<def-geom:envelope>"                      : "<{$so_env}/{$eubwid}:1>",
            "<def-zoi:zoneOfInfluence>"                : "<{$so_zoi}/{$eubwid}:1>",
            "<onsadmingeo:district>"                  : [ "<{os_uri}>" ,
                                                          "<{empty(gss) ? null : 
                                                                         'http://statistics.data.gov.uk/id/statistical-geography/' + gss}>"
                                                        ]                                                         
        },
    #############################################################################################################################
    # Bathing-water zone of influence
    #############################################################################################################################
        {   "name"                                    : "zone-of-influence",
            "@id"                                     : "<{$so_zoi}/{$eubwid}:1>",
            "<rdf:type>"                              : "<def-zoi:ZoneOfInfluence>",
            "<rdfs:label>"                            : "Zone of Influence at {description_english}@en",
            "<skos:prefLabel>"                        : "Zone of Influence at {description_english}@en",
            "<skos:notation>"                         : [ "{$eubwid}", "{$eubwid}^^def-zoi:zoiCode" ],
            "<def-zoi:zoiNotation>"                   : "{$eubwid}^^def-zoi:zoiCode" ,
            "<def-bw:bathingWater>"                   : "<{$id_bw}/{$eubwid}>",
            "<geometry:extent>"                       : "<{$so_zoi}/{$eubwid}:1/extent>"
        },
    #############################################################################################################################
    # Zone of influence extent 
    #############################################################################################################################
        {   "name"                                    : "zoi-extent",
            "@id"                                     : "<{$so_zoi}/{$eubwid}:1/extent>",
            "<rdf:type>"                              : "<geometry:AbstractGeometry>",
            "<geometry:asGML>"                        : "{zoi_geometry}^^rdf:XMLLiteral"
        },
    #############################################################################################################################
    # Alternate bathing water URI (vestigial)
    #############################################################################################################################
        {   "name"                                    : "alt-bathing-water",
            "@id"                                     : "<{$id_bw}/{$altBwId}>",
            "<rdf:type>"                              : [ "<def-bw:BathingWater>", "<{$bwType}>" ],
            "<owl:sameAs>"                            : "<{$id_bw}/{$eubwid}>",
            "<rdfs:label>"                            : [ "{description_english.lang('en')}",
                                                          "{empty(description_welsh) ? null : description_welsh.lang('cy') }" ],
            "<skos:prefLabel>"                        : [ "{description_english.lang('en')}", 
                                                          "{empty(description_welsh) ? null : description_welsh.lang('cy') }" ]
        },
    #############################################################################################################################
    # Map-bound envelope for a bathing-water
    #############################################################################################################################
       {    "name"                                    : "envelope",
            "@id"                                     : "<{$so_env}/{$eubwid}:1>",
            "<rdf:type>"                              : "<def-geom:Envelope>",
            "<rdfs:label>"                            : "Map Bounds for {description_english}@en",
            "<geometry:asGML>"                        : "{$envelopeGML}^^rdf:XMLLiteral",
            "<def-geom:dimensions>"                   : "{$srsDim}^^xsd:integer",
            "<def-geom:srs>"                          : "<{$srs}",
            "<def-geom:lowerCorner>"                  : "<{$so_env}/{$eubwid}:1/lowerCorner>",
            "<def-geom:upperCorner>"                  : "<{$so_env}/{$eubwid}:1/upperCorner>"
        },
    #############################################################################################################################
    # Map-bound envelope lower corner
    #############################################################################################################################
        {   "name"                                    : "envelope-lower",
            "@id"                                     : "<{$so_env}/{$eubwid}:1/lowerCorner>",
            "<rdf:type>"                              : "<def-geom:Point>",
            "<def-geom:dimensions>"                   : "{$srsDim}^^xsd:integer",
            "<def-geom:srs>"                          : "<{$srs}>",
            "<def-geom:x>"                            : "{$bb_xmin}^^xsd:decimal",
            "<def-geom:y>"                            : "{$bb_ymin}^^xsd:decimal",
            "<spatialrelations:easting>"              : "{$bb_xmin}^^xsd:decimal",
            "<spatialrelations:northing>"             : "{$bb_ymin}^^xsd:decimal"
        },
    #############################################################################################################################
    # Map-bound envelope upper corner
    #############################################################################################################################
        {   "name"                                    : "envelope-upper",
            "@id"                                     : "<{$so_env}/{$eubwid}:1/upperCorner>",
            "<rdf:type>"                              : "<def-geom:Point>",
            "<def-geom:dimensions>"                   : "{$srsDim}^^xsd:integer",
            "<def-geom:srs>"                          : "<{$srs}>",
            "<def-geom:x>"                            : "{$bb_xmax}^^xsd:decimal",
            "<def-geom:y>"                            : "{$bb_ymax}^^xsd:decimal",
            "<spatialrelations:easting>"              : "{$bb_xmax}^^xsd:decimal",
            "<spatialrelations:northing>"             : "{$bb_ymax}^^xsd:decimal"
        },
    #############################################################################################################################
    # Bathing Water Sampling Point
    #############################################################################################################################
        {   "name"                                    : "sampling-point",
            "@id"                                     : "<{$so_sp}/{$bwspid}>",
            "<rdf:type>"                              : "<{$def_sp}/SamplingPoint>",
            "<rdfs:label>"                            : "Sampling Point at {description_english}@en",
            "<spatialrelations:easting>"              : "{$easting}",
            "<spatialrelations:northing>"             : "{$northing}",
            "<geo:lat>"                               : "{latitude_etrs89.datatype('xsd:decimal')}",
            "<geo:long>"                              : "{latitude_etrs89.datatype('xsd:decimal')}",
            "<def-bw:bathingWater>"                   : "<{$id_bw}/{$eubwid}>",
            "<skos:notation>"                         : [ "{$bwspid}", "{$bwspid}^^def-ef:samplePointCode" ],
            "<def-sp:samplePointCode>"                : "{$bwspid}^^def-sp:samplePointCode",
            "<onsadmingeo:district>"                  : [ "<{os_uri}>" ,
                                                          "<{empty(gss) ? null : 
                                                                         'http://statistics.data.gov.uk/id/statistical-geography/' + gss}>"
                                                        ]                                                         
        },
    #############################################################################################################################
    # Vestiguial ONS and OS Admin geo entries for disrticts
    #############################################################################################################################
        { "name"                                      : "os-district",
          "@id"                                       : "<{os_uri}>",
          "<rdf:type>"                                : "<admingeo:CivilAdministrativeArea>",
          "<admingeo:gssCode>"                        : "{gss}"
        },
        { "name"                                      : "ons-district",
          "@id"                                       : "<{empty(gss) ? null : 
                                                                       'http://statistics.data.gov.uk/id/statistical-geography/' + gss}>",
          "<admingeo:gssCode>"                        : "{gss}"
        },
        
    ]
}